generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Sex {
  male
  female
  other
}

enum UserRole {
  admin
  doctor
  assistant
  receptionist
  user
  beta_tester
}

model User {
  id           String                   @id
  email        String                   @unique
  fullName     String
  passwordHash String
  role         UserRole                 @default(user)
  isActive     Boolean                  @default(true)
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt

  sessions            AuthSession[]
  permissionOverrides UserPermissionOverride[]
  auditTargets        PermissionAuditLog[] @relation("AuditTarget")
  auditChangers       PermissionAuditLog[] @relation("AuditChanger")
  activityLogs        UserActivityLog[]
}

model AuthSession {
  id           String   @id
  userId       String
  tokenHash    String   @unique
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  lastSeenAt   DateTime @default(now())
  revokedAt    DateTime?
  userAgent    String?
  ipAddress    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model UserPermissionOverride {
  id         String   @id
  userId     String
  key        String
  isAllowed  Boolean
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
  @@index([key])
}

model PermissionAuditLog {
  id              String   @id
  targetUserId    String
  changedByUserId String
  changedAt       DateTime @default(now())
  key             String
  oldValue        Boolean
  newValue        Boolean
  targetUser      User @relation("AuditTarget", fields: [targetUserId], references: [id], onDelete: Cascade)
  changedByUser   User @relation("AuditChanger", fields: [changedByUserId], references: [id], onDelete: Cascade)

  @@index([targetUserId])
  @@index([changedAt])
}

model UserActivityLog {
  id         String   @id
  userId     String
  action     String
  page       String?
  entityType String?
  entityId   String?
  details    Json?
  createdAt  DateTime @default(now())
  ipAddress  String?
  user       User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Patient {
  patientId        String   @id
  title            String?
  lastName         String
  firstName        String
  sex              Sex
  birthDate        DateTime
  birthPlace       String?
  insuranceNum     String?
  phone            String?
  email            String?
  country          String?
  isForeignAddress Boolean  @default(false)
  zipCode          String?
  city             String?
  street           String?
  patientType      String?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isArchived       Boolean  @default(false)
  createdByUserId  String?

  quotes    Quote[]
  snapshots DentalStatusSnapshot[]
}

model Quote {
  quoteId            String   @id
  patientId          String
  quoteStatus        String
  createdAt          DateTime @default(now())
  lastStatusChangeAt DateTime
  isDeleted          Boolean  @default(false)
  data               Json
  createdByUserId    String?

  patient Patient @relation(fields: [patientId], references: [patientId])

  @@index([patientId])
}

model DentalStatusSnapshot {
  snapshotId String   @id
  patientId  String
  takenAt    DateTime
  note       String?
  teeth      Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [patientId])

  @@index([patientId])
  @@index([takenAt])
}

model CatalogItem {
  catalogItemId         String  @id
  catalogCode           String
  catalogName           String
  catalogUnit           String
  catalogPrice          Float
  catalogPriceCurrency  String
  catalogVatRate        Float
  catalogTechnicalPrice Float
  catalogCategory       String
  hasTechnicalPrice     Boolean @default(false)
  isFullMouth           Boolean @default(false)
  isArch                Boolean @default(false)
  isActive              Boolean @default(true)
}

model AppSettings {
  id        String   @id
  data      Json
  updatedAt DateTime @updatedAt
}

model Invoice {
  id              String   @id
  patientId       String
  quoteId         String
  status          String
  createdAt       DateTime
  data            Json
  createdByUserId String?

  @@index([patientId])
  @@index([quoteId])
}

model NeakCheck {
  id        String   @id
  patientId String
  checkedAt DateTime
  data      Json

  @@index([patientId])
  @@index([checkedAt])
}

model OdontogramCurrent {
  patientId String   @id
  updatedAt DateTime
  data      Json
}

model OdontogramDaily {
  patientId String
  dateKey   String
  updatedAt DateTime
  data      Json

  @@id([patientId, dateKey])
  @@index([patientId])
}

model OdontogramTimeline {
  snapshotId String   @id
  patientId  String
  updatedAt  DateTime
  data       Json

  @@index([patientId])
  @@index([updatedAt])
}
